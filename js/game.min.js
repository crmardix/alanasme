var FPS=30;var REFRESH=1000/FPS;var storage=null;var sfx_volume=1;var music_voume=1;var elem_background=$("#background");var canv_background=elem_background[0];var ctx_background=canv_background.getContext("2d");var elem_enemies=$("#enemies");var canv_enemies=elem_enemies[0];var ctx_enemies=canv_enemies.getContext("2d");var elem_projectiles=$("#projectiles");var canv_projectiles=elem_projectiles[0];var ctx_projectiles=canv_projectiles.getContext("2d");var elem_announcement=$("#announcement");var canv_announcement=elem_announcement[0];var ctx_announcement=canv_announcement.getContext("2d");var screen_width=480;var screen_height=320;var field_x1=0;var field_x2=400;var field_y1=100;var field_y2=200;var current_level=0;var initial_spawn_delay=1000;var enemies_spawned=0;var enemies_remaining=0;var player=null;var enemies=new Array();var enemies_moving=new Array();var projectiles=new Array();var target=new Array();var shooting=null;var updater=null;var enemy_spawn=null;function Timer(){this.id=null;this.func=null;this.interval=null;this.start_time=null;this.setTimeout=function(func,overflow){this.func=func;this.interval=overflow;this.id=window.setTimeout(this.func,this.interval);this.start_time=(new Date()).getTime();};this.setInterval=function(func,overflow){this.func=func;this.interval=overflow;this.id=window.setInterval(function(){this.func();this.start_time=(new Date()).getTime();},this.interval);this.start_time=(new Date()).getTime();};this.pause=function(){};}function randrange(minimum,maximum,decimal_places){var value=minimum+(Math.random()*(maximum-minimum));return typeof decimal_places=="undefined"?Math.round(value):value.toFixed(decimal_places);}function get_lines(ctx,phrase,max_length){eval('var words = phrase.\x73\x70\x6C\x69\x74(" ");');var lines=new Array();var last_phrase="";var measure=0;for(var i=0;i<words.length;i++){var word=words[i];measure=ctx.measureText(last_phrase+word).width;if(measure<max_length){last_phrase+=(" "+word);}else{lines.push(last_phrase);last_phrase=word;}if(i==words.length-1){lines.push(last_phrase);break;}}return lines;}function update(){ctx_enemies.clearRect(0,0,canv_enemies.width,canv_enemies.height);var delta=player.cool_rate/FPS;if(player.heat>0){player.heat-=delta;}if(player.heat<0){player.heat=0;}if(player.overheating){if(player.heat<=player.heat_tolerance){player.overheating=false;}}for(var i=0;i<enemies.length;i++){if(enemies[i]!==undefined){enemies[i].update();}}for(var i=0;i<projectiles.length;i++){projectiles[i].update();}}function get_coordinates(data){var x=Math.floor(data.pageX-elem_background.offset().left);var y=Math.floor(data.pageY-elem_background.offset().top);var coordinates=new Array(x,y);return coordinates;}function announce(text,callback){ctx_announcement.clearRect(0,0,canv_announcement.width,canv_announcement.height);ctx_announcement.fillStyle="#f00";ctx_announcement.lineWidth=2;ctx_announcement.strokeStyle="#000";ctx_announcement.font="50px sans-serif";ctx_announcement.textBaseline="top";ctx_announcement.fillText(text,0,0);ctx_announcement.strokeText(text,0,0);elem_announcement.fadeIn(1000).delay(2000).fadeOut(1000,function(){if($.isFunction(callback)){callback();}});}function pause(){}function draw_world(){ctx_background.fillStyle="#f00";ctx_background.fillRect(0,0,elem_background.width,elem_background.height);ctx_background.fillStyle="#0f0";ctx_background.fillRect(0,field_y1,field_x2,field_y2);}function start_game(wave,shop,player){if(player!==undefined){}current_level=wave;if(shop){elem_shop.fadeIn(100);}else{start_dialogue(current_level,function(){start_wave(current_level);});}}function init(){$("canvas").hide();draw_mainmenu();elem_mainmenu.show();player=new Player();draw_world();draw_shop();elem_enemies.mousedown(function(pos){target=get_coordinates(pos);player.attack();shooting=window.setInterval(player.attack,1000/player.attack_rate);}).mousemove(function(pos){var coordinates=target=get_coordinates(pos);if(coordinates[0]<=field_x2&&coordinates[1]<=field_y2&&coordinates[1]>=field_y1){target=get_coordinates(pos);}else{window.clearInterval(shooting);}}).mouseup(function(){window.clearInterval(shooting);});}function load_storage(key){if(storage=="local"){return localStorage.getItem(key);}else{if(storage=="session"){return sessionStorage.getItem(key);}else{return false;}}}$(document).ready(function(){if(Modernizr.canvas){if(Modernizr.canvastext){if(Modernizr.localstorage){storage="local";}else{if(Modernizr.sessionStorage){storage="session";}else{}}if(Modernizr.audio){if(storage!==null){var volume=load_storage("sfx_volume");if(volume!==undefined){sfx_volume=volume;}volume=load_storage("music_volume");if(volume!==undefined){music_voume=volume;}}}else{sfx_volume=0;music_voume=0;}if(Modernizr.touch){}init();}else{}}else{}});